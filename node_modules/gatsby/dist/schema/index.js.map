{"version":3,"sources":["../../src/schema/index.js"],"names":["tracer","require","globalTracer","store","nodeStore","createSchemaComposer","buildSchema","rebuildSchemaWithSitePage","builtInFieldExtensions","TypeConflictReporter","getAllFieldExtensions","schemaCustomization","fieldExtensions","customFieldExtensions","getState","buildInferenceMetadata","types","Promise","resolve","length","typeNames","processNextType","typeName","pop","dispatch","type","payload","nodes","getNodesByType","setTimeout","build","parentSpan","fullMetadataBuild","spanArgs","childOf","span","startSpan","getTypes","thirdPartySchemas","printConfig","inferenceMetadata","config","mapping","typeMapping","typeConflictReporter","sortedTypes","filter","plugin","name","schemaComposer","schema","printConflicts","finish","rebuild","rebuildWithSitePage","composer","module","exports"],"mappings":"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","sourcesContent":["/* @flow */\n\nconst tracer = require(`opentracing`).globalTracer()\nconst { store } = require(`../redux`)\nconst nodeStore = require(`../db/nodes`)\nconst { createSchemaComposer } = require(`./schema-composer`)\nconst { buildSchema, rebuildSchemaWithSitePage } = require(`./schema`)\nconst { builtInFieldExtensions } = require(`./extensions`)\nconst { TypeConflictReporter } = require(`./infer/type-conflict-reporter`)\n\nconst getAllFieldExtensions = () => {\n  const {\n    schemaCustomization: { fieldExtensions: customFieldExtensions },\n  } = store.getState()\n\n  return {\n    ...customFieldExtensions,\n    ...builtInFieldExtensions,\n  }\n}\n\n// Schema building requires metadata for type inference.\n// Technically it means looping through all type nodes, analyzing node structure\n// and then using this aggregated node structure in related GraphQL type.\n// Actual logic for inference located in inferenceMetadata reducer and ./infer\n// Here we just orchestrate the process via redux actions\nconst buildInferenceMetadata = ({ types }) =>\n  new Promise(resolve => {\n    if (!types || !types.length) {\n      resolve()\n      return\n    }\n    const typeNames = [...types]\n    // TODO: use async iterators when we switch to node>=10\n    //  or better investigate if we can offload metadata building to worker/Jobs API\n    //  and then feed the result into redux?\n    const processNextType = () => {\n      const typeName = typeNames.pop()\n      store.dispatch({\n        type: `BUILD_TYPE_METADATA`,\n        payload: {\n          typeName,\n          nodes: nodeStore.getNodesByType(typeName),\n        },\n      })\n      if (typeNames.length > 0) {\n        // Give event-loop a break\n        setTimeout(processNextType, 0)\n      } else {\n        resolve()\n      }\n    }\n    processNextType()\n  })\n\nconst build = async ({ parentSpan, fullMetadataBuild = true }) => {\n  const spanArgs = parentSpan ? { childOf: parentSpan } : {}\n  const span = tracer.startSpan(`build schema`, spanArgs)\n\n  if (fullMetadataBuild) {\n    // Build metadata for type inference and start updating it incrementally\n    // except for SitePage type: we rebuild it in rebuildWithSitePage anyway\n    // so it makes little sense to update it incrementally\n    // (and those updates may have significant performance overhead)\n    await buildInferenceMetadata({ types: nodeStore.getTypes() })\n    store.dispatch({ type: `START_INCREMENTAL_INFERENCE` })\n    store.dispatch({ type: `DISABLE_TYPE_INFERENCE`, payload: [`SitePage`] })\n  }\n\n  const {\n    schemaCustomization: { thirdPartySchemas, types, printConfig },\n    inferenceMetadata,\n    config: { mapping: typeMapping },\n  } = store.getState()\n\n  const typeConflictReporter = new TypeConflictReporter()\n\n  // Ensure that user-defined types are processed last\n  const sortedTypes = [\n    ...types.filter(\n      type => type.plugin && type.plugin.name !== `default-site-plugin`\n    ),\n    ...types.filter(\n      type => !type.plugin || type.plugin.name === `default-site-plugin`\n    ),\n  ]\n\n  const fieldExtensions = getAllFieldExtensions()\n  const schemaComposer = createSchemaComposer({ fieldExtensions })\n  const schema = await buildSchema({\n    schemaComposer,\n    nodeStore,\n    types: sortedTypes,\n    fieldExtensions,\n    thirdPartySchemas,\n    typeMapping,\n    printConfig,\n    typeConflictReporter,\n    inferenceMetadata,\n    parentSpan,\n  })\n\n  typeConflictReporter.printConflicts()\n\n  store.dispatch({\n    type: `SET_SCHEMA_COMPOSER`,\n    payload: schemaComposer,\n  })\n  store.dispatch({\n    type: `SET_SCHEMA`,\n    payload: schema,\n  })\n\n  span.finish()\n}\n\nconst rebuild = async ({ parentSpan }) =>\n  await build({ parentSpan, fullMetadataBuild: false })\n\nconst rebuildWithSitePage = async ({ parentSpan }) => {\n  const spanArgs = parentSpan ? { childOf: parentSpan } : {}\n  const span = tracer.startSpan(\n    `rebuild schema with SitePage context`,\n    spanArgs\n  )\n  await buildInferenceMetadata({ types: [`SitePage`] })\n\n  // Disabling incremental inference for SitePage after the initial build\n  // as it has a significant performance cost for zero benefits.\n  // The only benefit is that schema rebuilds when SitePage.context structure changes.\n  // (one can just restart `develop` in this case)\n  store.dispatch({ type: `DISABLE_TYPE_INFERENCE`, payload: [`SitePage`] })\n\n  const {\n    schemaCustomization: { composer: schemaComposer },\n    config: { mapping: typeMapping },\n    inferenceMetadata,\n  } = store.getState()\n\n  const typeConflictReporter = new TypeConflictReporter()\n\n  const schema = await rebuildSchemaWithSitePage({\n    schemaComposer,\n    nodeStore,\n    fieldExtensions: getAllFieldExtensions(),\n    typeMapping,\n    typeConflictReporter,\n    inferenceMetadata,\n    parentSpan,\n  })\n\n  typeConflictReporter.printConflicts()\n\n  store.dispatch({\n    type: `SET_SCHEMA_COMPOSER`,\n    payload: schemaComposer,\n  })\n  store.dispatch({\n    type: `SET_SCHEMA`,\n    payload: schema,\n  })\n\n  span.finish()\n}\n\nmodule.exports = {\n  build,\n  rebuild,\n  rebuildWithSitePage,\n}\n"],"file":"index.js"}